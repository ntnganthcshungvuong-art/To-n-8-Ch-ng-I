<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quiz Chế Độ Máy Chiếu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:'Segoe UI',sans-serif}.hidden{display:none}</style>
</head>
<body class="bg-gradient-to-r from-yellow-100 to-green-200 min-h-screen flex flex-col items-center justify-center p-4">
  <div id="menuScreen" class="text-center max-w-3xl">
    <h1 class="text-3xl font-bold mb-4">📽️ Quiz Máy Chiếu - Chương I</h1>
    <p class="mb-4 text-gray-700">Chọn bài để bắt đầu hiển thị câu hỏi:</p>
    <div class="grid grid-cols-2 gap-3">
      <button onclick="selectLesson('Bai1')" class="btn">Bài 1: Đơn thức</button>
      <button onclick="selectLesson('Bai2')" class="btn">Bài 2: Đa thức</button>
      <button onclick="selectLesson('Bai3')" class="btn">Bài 3: Cộng & Trừ đa thức</button>
      <button onclick="selectLesson('Bai4')" class="btn">Bài 4: Nhân đa thức</button>
      <button onclick="selectLesson('Bai5')" class="btn">Bài 5: Chia đa thức</button>
      <button onclick="selectLesson('TongHop')" class="btn bg-purple-500 hover:bg-purple-600">🔎 Tổng hợp Chương I</button>
    </div>
  </div>

  <div id="quizScreen" class="hidden w-full max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <p id="questionCounter" class="font-semibold">Câu 1/20</p>
      <p id="timer" class="font-bold text-red-600">⏳ 45s</p>
    </div>
    <div id="questionBox" class="bg-white p-5 rounded-2xl shadow-lg mb-3"></div>
    <div id="optionsBox" class="grid grid-cols-1 gap-3"></div>
    <button onclick="nextQuestion()" id="nextBtn" class="hidden mt-4 bg-green-500 text-white px-6 py-2 rounded-xl hover:bg-green-600">Câu tiếp theo</button>
  </div>

<script>
let quizData=[], currentIndex=0, timer, timeLeft=45;

async function selectLesson(lesson){
  try {
    const response = await fetch('https://ntnganthcshungvuong-art.github.io/To-n-8-Ch-ng-I/questions.json?_=' + Date.now());
    const all = await response.json();
    quizData = pick20(all[lesson] || []);
    currentIndex = 0;
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('quizScreen').classList.remove('hidden');
    showQuestion();
    startTimer();
  } catch(e) {
    alert("❌ Không tải được dữ liệu: " + e);
  }
}

function pick20(all){
  const nb_th = all.filter(q=>q.level==='NB'||q.level==='TH');
  const others = all.filter(q=>q.level==='VD'||q.level==='VC');
  function pick(arr,n){ const out=[]; for(let i=0;i<n;i++){ out.push(arr[Math.floor(Math.random()*arr.length)]); } return out; }
  return shuffleArray([...pick(nb_th,12), ...pick(others,8)]);
}

function startTimer(){
  timeLeft=45;
  document.getElementById('timer').innerText='⏳ '+timeLeft+'s';
  timer=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText='⏳ '+timeLeft+'s';
    if(timeLeft<=0){ nextQuestion(); }
  },1000);
}

function showQuestion(){
  clearInterval(timer); 
  startTimer();

  const q = quizData[currentIndex];
  document.getElementById('questionCounter').innerText=`Câu ${currentIndex+1}/20`;

  // Bỏ nhãn NB/TH/VD/VC nếu có
  let cleanQ = q.q.replace(/\s+(NB|TH|VD|VC)$/,''); 
  document.getElementById('questionBox').innerHTML = `<span class="text-2xl font-bold">${cleanQ}</span>`;

  let html='';
  shuffleArray([...(q.options||[])]).forEach(opt=>{
    html += `<button data-value="${escapeHtml(opt)}" 
                    onclick="selectAnswer(this,'${escapeJs(q.a)}','${escapeJs(q.hint||'')}')" 
                    class="bg-white border rounded-xl p-3 text-left hover:bg-blue-100 text-lg font-semibold">${opt}</button>`;
  });
  document.getElementById('optionsBox').innerHTML = html;

  document.getElementById('nextBtn').classList.add('hidden');
}

function selectAnswer(btn, correct, hint){
  const buttons=document.querySelectorAll('#optionsBox button');
  buttons.forEach(b=>b.disabled=true);
  const chosen=(btn.dataset.value||'').trim();
  const correctTrim=(correct||'').trim();
  if(chosen===correctTrim){
    btn.classList.add('bg-green-300');
    alert("✅ ĐÚNG!");
  } else {
    btn.classList.add('bg-red-300');
    buttons.forEach(b=>{
      if((b.dataset.value||'').trim()===correctTrim){
        b.classList.add('ring-2','ring-green-600');
      }
    });
    alert("❌ SAI. Đáp án đúng: "+correctTrim+"\\n👉 Gợi ý: "+hint);
  }
  document.getElementById('nextBtn').classList.remove('hidden');
  clearInterval(timer);
}

function nextQuestion(){
  currentIndex++;
  if(currentIndex < quizData.length){
    showQuestion();
  } else {
    alert('🎉 Hết 20 câu!');
    location.reload();
  }
}

function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function escapeJs(s){
  return (s||'')
    .replace(/\\/g,'\\\\')
    .replace(/'/g,"\\'")
    .replace(/"/g,'\\"');
}

function escapeHtml(s){
  return (s||'')
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}
</script>

<style>.btn{@apply bg-blue-500 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-blue-600}</style>
</body>
</html>
