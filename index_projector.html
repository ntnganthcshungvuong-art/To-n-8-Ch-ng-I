<script>
let quizData=[], currentIndex=0, timer, timeLeft=45;

async function selectLesson(lesson){
  const response = await fetch('https://ntnganthcshungvuong-art.github.io/To-n-8-Ch-ng-I/questions.json?_=' + Date.now());
  const all = await response.json();
  quizData = pick20(all[lesson] || []);
  currentIndex = 0;
  document.getElementById('menuScreen').classList.add('hidden');
  document.getElementById('quizScreen').classList.remove('hidden');
  showQuestion();
  startTimer();
}

function pick20(all){
  const nb_th = all.filter(q=>q.level==='NB'||q.level==='TH');
  const others = all.filter(q=>q.level==='VD'||q.level==='VC');
  function pick(arr,n){ const out=[]; for(let i=0;i<n;i++){ out.push(arr[Math.floor(Math.random()*arr.length)]); } return out; }
  return shuffleArray([...pick(nb_th,12), ...pick(others,8)]);
}

function startTimer(){
  timeLeft=45;
  document.getElementById('timer').innerText='⏳ '+timeLeft+'s';
  timer=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText='⏳ '+timeLeft+'s';
    if(timeLeft<=0){ nextQuestion(); }
  },1000);
}

function showQuestion(){
  clearInterval(timer); 
  startTimer();

  const q = quizData[currentIndex];

  // Đếm câu
  document.getElementById('questionCounter').innerText=`Câu ${currentIndex+1}/20`;

  // Hiển thị câu hỏi, bỏ NB/TH/VD/VC ở cuối nếu có
  let cleanQ = q.q.replace(/\s+(NB|TH|VD|VC)$/,''); 
  document.getElementById('questionBox').innerHTML = `<span class="text-2xl font-bold">${cleanQ}</span>`;

  // Hiển thị đáp án với chữ lớn hơn
  let html='';
  shuffleArray([...(q.options||[])]).forEach(opt=>{
    html += `<button data-value="${escapeHtml(opt)}" 
                    onclick="selectAnswer(this,'${escapeJs(q.a)}','${escapeJs(q.hint||'')}')" 
                    class="bg-white border rounded-xl p-3 text-left hover:bg-blue-100 text-lg font-semibold">${opt}</button>`;
  });
  document.getElementById('optionsBox').innerHTML = html;

  // Ẩn nút "Tiếp theo" ban đầu
  document.getElementById('nextBtn').classList.add('hidden');
}


function selectAnswer(btn, correct, hint){
  const buttons=document.querySelectorAll('#optionsBox button');
  buttons.forEach(b=>b.disabled=true);
  const chosen=(btn.dataset.value||'').trim();
  const correctTrim=(correct||'').trim();
  if(chosen===correctTrim){
    btn.classList.add('bg-green-300');
    alert("✅ ĐÚNG!");
  } else {
    btn.classList.add('bg-red-300');
    buttons.forEach(b=>{
      if((b.dataset.value||'').trim()===correctTrim){
        b.classList.add('ring-2','ring-green-600');
      }
    });
    alert("❌ SAI. Đáp án đúng: "+correctTrim+"\\n👉 Gợi ý: "+hint);
  }
  document.getElementById('nextBtn').classList.remove('hidden');
  clearInterval(timer);
}

function nextQuestion(){
